---
title: "Heart Disease - Analysis 2.0"
author: "Carlos Kelaidis"
date: "12/5/2021"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Read in data set:
```{r}
heart_dat <- read.csv("~/Documents/My Working Directory/Personal Projects/Heart Attack Prediciton & Analysis/data/heart.csv")
#View(heart_dat)
```

Load some libraries:
```{r}
library(tidyverse)
library(knitr)
library(ggpubr)
library(tibble)
```

#EDA

Let's look at our data set:
```{r}
dim(heart_dat)
heart_dat[1:5,]
```

Ok so we have 918 observation and 11 variables + the repsonse (**HeartDisease**)

```{r}
str(heart_dat)
```

```{r}
cor(heart_dat[,-c(2,3,7,9,11,13)])
```

Visualizing data:
```{r}
#Want to observe distribution of sex
summary(heart_dat$Age)
summary(heart_dat$Sex)
#Do want to observe Age, see the distribution of young VS old, dont want no crazy weights cause by an uneven distribution.

#Sex distribution
heart_dat%>%
  #group_by(HeartDisease)%>%
  ggplot(aes(Sex))+
  geom_bar(aes(fill=Sex))+
  scale_fill_manual(values = c("darkblue", "darkorange"))

#Let's look at age distribution between sexes
heart_dat%>%
  ggdensity(x="Age", add="mean", rug=T,
            color="Sex")

#Convert HeartDisease to factor
heart_dat$fac_HD<-factor(NA, level=c("1", "0"))
heart_dat$fac_HD[heart_dat$HeartDisease==1]<-"1"
heart_dat$fac_HD[heart_dat$HeartDisease==0]<-"0"

heart_dat%>%
  #group_by(HeartDisease)%>%
  ggplot(aes(Sex))+
  geom_bar(aes(fill=fac_HD), position="dodge")+
  scale_fill_manual(values = c("darkred", "white"))+
  labs(fill="Heart Disease; 1 = Yes, 0 = No")


```

We have a much larger amount of males (725) compared to females (193).

The age distribution between sexes is similar. For women it seems pretty normal around the average age (around 52), for men it is a bit more skewed to the right (towards older ages), so men are generally older than women in this dataset => this can influence our results, as we see further down below older ages (particularly older than the mean) are more correlated to the disease than younger ages => more older ages in men => more cases in men.

We see also in males, there are more cases than not, while in females the not cases are larger in count than the cases.


We see that broken down right below (m2)
```{r}
#m<-as.tibble(c(heart_dat%>%
  #select(Sex, HeartDisease)%>%
  #filter(Sex=="M")%>%
  #summarise(Males_with_Heart_disease=sum(HeartDisease=="1")),
  #heart_dat%>%
  #select(Sex, HeartDisease)%>%
  #filter(Sex=="M")%>%
  #summarise(Males_without_Heart_disease=sum(HeartDisease=="0")),
  #heart_dat%>%
  #select(Sex, HeartDisease)%>%
  #filter(Sex=="F")%>%
  #summarise(Females_with_Heart_disease=sum(HeartDisease=="1")),
  #heart_dat%>%
  #select(Sex, HeartDisease)%>%
  #filter(Sex=="F")%>%
  #summarise(Females_without_Heart_disease=sum(HeartDisease=="0")),
  #))


#m2<-pivot_longer(m,c("Males_with_Heart_disease", "Males_without_Heart_disease",
 #                    "Females_with_Heart_disease",
  #                   "Females_without_Heart_disease"),
   #              names_to="Class", values_to="Count")

#m2
heart_dat[1:5,]
```

Above, we see the count broken down.

Let's observe **ChestPainType** and **RestingBP**, also perhaps **Age** with **RestingBP** or **Cholesterol**:
```{r}
#CHestPainType & RestingBP
box1<-heart_dat%>%
  ggplot(aes(x=ChestPainType, y=RestingBP))+
  geom_boxplot(aes(color=ChestPainType))

box2<-heart_dat%>%
  ggplot(aes(x=ChestPainType, y=Cholesterol))+
  geom_boxplot(aes(color=ChestPainType))

ggarrange(box1, box2, ncol=2)
```

We see all boxplots at about the same level, average **RestingBP** is about the same in all four different **ChestPainType**s. 

With regards to **Cholesterol** however, it appears that ChestPainType has a more uneven distribution, the means however appear to be similar however.


```{r}
heart_dat%>%
  ggplot(aes(x=ChestPainType, y=RestingBP))+
  geom_boxplot(aes(color=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No")

heart_dat%>%
  ggplot(aes(x=ChestPainType, y=Cholesterol))+
  geom_boxplot(aes(color=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No")
```

Again, distributions of Resting Blood Pressures appear to be fairly constant among diseased and non-diseased for all Chest Pain Types.

Uneven for Cholesterol, we examine Cholesterol in further detail later on.

```{r}
heart_dat%>%
  ggplot(aes(x=Age, y=RestingBP))+
  geom_point(aes(col=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No")
```

So we see that Resting Blood Pressure levels are fairly constant for all ages, but we do see a higher concentration of Heart Disease Cases for higher age values. => **Age**!

Want to look at **Age** a bit more - Namely its distribution:
```{r}
summary(heart_dat$Age)

#Tot diseased
length(which(heart_dat$HeartDisease==1))#508

#Tot not diseased
length(which(heart_dat$HeartDisease==0))#410

bar_graph<-heart_dat%>%
  ggplot(aes(Age))+
  geom_histogram(bins=10,aes(col=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No")

dens_dist<-heart_dat%>%
  ggplot(aes(Age))+
  geom_density(aes(col=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange"))+
  geom_vline(aes(xintercept=mean(Age)), col="blue", lty=2)+
  labs(color="Heart Disease; 1 = Yes, 0 = No")

dens_dist2<-heart_dat%>%
  ggplot(aes(Age))+
  geom_density(aes(col=Sex))+
  scale_color_manual(values = c("darkblue", "orange"))+
  geom_vline(aes(xintercept=mean(Age)), col="blue", lty=2)+
  labs(color="Sex")

bar_graph
ggarrange(dens_dist, dens_dist2, nrow=2)
```

Based on the density plot wee see that, higher concentrations of diseased patients are reserved for ages higher than the mean age, while for non-diseased patients, we see a high density around the mean age, as well as for ages smaller than the mean age. 

We can see, just as the dsitribution of males is skewed towards older ages, so is the distribution of diseased cases => Just as wee saw before a there is a higher concentration of cases for older ages which is why there is also more cases in men (they are older than women in this dataset).

It is not so that one sex has more risk of having heart disease, as it is that age plays a significant role.

Visualizing some more variables:
```{r}
heart_dat%>%
  ggplot(aes(x=Age, y=Cholesterol))+
  geom_point(aes(col=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No")
```

Cholesterol levels are fairly even among all age brackets, however there is a definite relationship between patients that have Cholesterol levels of 0 and that have Heart Disease. => **Cholesterol**!

```{r}
#Chest Pain Type and Disease status
heart_dat%>%
  ggplot(aes(x=ChestPainType))+
  geom_bar(aes(col=fac_HD), position="dodge")+
  scale_color_manual(values = c("darkblue", "orange"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No")
```

We can see that most Heart Disease cases are reserved for patients that have the **ASY** type of chest pain. 

Let's see whether **Age** or any other variables are related to **ChestPainType**:
```{r}
bar1<-heart_dat%>%
  ggplot(aes(x=Age))+
  geom_bar(aes(col=ChestPainType))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue"))

bar2<-heart_dat%>%
  ggplot(aes(ChestPainType))+
  geom_bar(aes(col=ChestPainType))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue"))

ggarrange(bar2,bar1, nrow=2)
```

The **ASY** relationship to the disease is a bit more explained. I believw the main reason for this assiociation is that we have a lot more counts of ASY chest pain type than for any other type of chest pain. Because if we look at how Chest Pain Types are distributed with regards to age, the dsitribution is fairly similar, meaning there is not one Chest Pain Type that is more prominent than others for a particualr age bracket/value, it is just that there is a much larger count of **ASY** chest pain type.

However, a good note is that Chest Pain Types are more prominent (for all chest pain types) among older age values.

**ChestPainType**!

Is it just that we have way more older ages than younger ones?
Let's look at that:
```{r}
#Create new factor, older >= mean(age), young < mean(age)
age<-factor(NA, levels = c("young", "mid", "aged"))

age[heart_dat$Age>=60]<-"aged"
age[heart_dat$Age<30]<-"young"
age[heart_dat$Age<60 & heart_dat$Age>=30]<-"mid"

length(which(age=='aged'))
length(which(age=='mid'))
length(which(age=='young'))
```

With a mean age of 53/54, the data set is fairly old.

Furthermore, we only have 4 observations below 30 yrs old, 250 above 60 and the majority; 661 between 30 and 60.

Perhaps I will change the split to 50 (instead of 30), see if we get a more even split of observations, or perhaps:
```{r}
age<-factor(NA, levels = c("young", "mid", "aged"))

age[heart_dat$Age>=60]<-"aged"
age[heart_dat$Age<50]<-"young"
age[heart_dat$Age<60 & heart_dat$Age>=50]<-"mid"

length(which(age=='aged'))
length(which(age=='mid'))
length(which(age=='young'))
```

The majority is between 50 and 60 years of age. We see also from the density curves above, that heart disease is more common in patients aged older than the mean age (53.5).

Are any other variables are related to **ChestPainType**:
```{r}
#RestingBP
ggarrange(heart_dat%>%
  ggplot(aes(x=Age, y=RestingBP))+
  geom_point(aes(col=ChestPainType))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue")),
  heart_dat%>%
  ggplot(aes(x=Age, y=RestingBP))+
  geom_point(aes(col=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No"), nrow=2)
```

I do not see any stricking observation between RestingBP and ChestPainType or even Age. RestingBP values are evened out across the age and chestpain distributions. => From what we see here not sure how relevant Resting BP is in accounting for Heart Disease.

So far we have noted the importance, purely based on observations, of **Age**, **ChestPainType** and **Cholesterol**.

We can also note **Sex**, however there are way more men than women, furthermore the men are aged older than women => so Sex will be heavily wieghted towards having the disease as more men => more aged & more aged => more diseased.

```{r}
#Cholesterol
ggarrange(heart_dat%>%
  ggplot(aes(x=Age, y=Cholesterol))+
  geom_point(aes(col=ChestPainType))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue")),
  heart_dat%>%
  ggplot(aes(x=Age, y=Cholesterol))+
  geom_point(aes(col=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No"), nrow=2)
```

We have already noted our observations for **Cholesterol**:

```{r}
#MaxHR
ggarrange(heart_dat%>%
  ggplot(aes(x=Age, y=MaxHR))+
  geom_point(aes(col=ChestPainType))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue")),
  heart_dat%>%
  ggplot(aes(x=Age, y=MaxHR))+
  geom_point(aes(col=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No"), nrow=2)
```

Ok so here we can see some type of relationship between MaxHR & ChestPainType (possible interaction term between them both), as well as  between MaxHR & Disease status.

First we see that the ASY chest pain type is (additionally to being reserved for older ages) reserved for lower heart rates. 

We also see that lower heart rates are associated with older ages (so possible interaction term between Age & MaxHR).

Finally, we see that lower heart rates are associated with diseased cased =>
**MaxHR**!

```{r}
#Oldpeak
ggarrange(heart_dat%>%
  ggplot(aes(x=Age, y=Oldpeak))+
  geom_point(aes(col=ChestPainType))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue")),
  heart_dat%>%
  ggplot(aes(x=Age, y=Oldpeak))+
  geom_point(aes(col=fac_HD))+
  scale_color_manual(values = c("darkblue", "orange", "darkorange", "lightblue"))+
  labs(color="Heart Disease; 1 = Yes, 0 = No"), nrow=2)
```

Similarly, higher values of **Oldpeak** seem to be associated with heart disease. These higher oldpeak values appear to be predominently nested in ages > mean(age), and with the ASY chest pain (although like we saw, there is much larger amount of ASY observation compared to the other chestpains, so perhaps we should not take ChestPainType so much into consideration).
=> **Oldpeak**!

```{r}
#Resting ECG
heart_dat%>%
  ggplot(aes(RestingECG))+
  geom_bar(aes(col=fac_HD), position="dodge")+
  labs(color="Heart Disease; 1 = Yes, 0 = No")
```

So for **RestingECG**, we see that the diseased cases outnumber the non-diseased for all three states. I do not see any particular Resting ECG state that is more associated with the disease status compared to others.

```{r}
#Exercise Angina
heart_dat%>%
  ggplot(aes(ExerciseAngina))+
  geom_bar(aes(col=fac_HD), position="dodge")+
  labs(color="Heart Disease; 1 = Yes, 0 = No")
```

We see however here, that **ExerciseAngina** is associated with the disease status. For patients that experienced exercise-induced angina, the cases majorely outnumber the non-cases. => **ExerciseAngina**!

Okay, so we have explored and visualized the relationships between the variables and have a pretty good understanding of the data set.

So far, purely through observations, variables associated with **HeartDisease** are:

  + **ExerciseAngina**
  + **Oldpeak**
  + **MaxHR**
  + **Age**
  + **Cholesterol**
  + **ChestPainType**


A few variables that seem to interact with eachother, for which there is the possibility of an interaction term, are:

  + **MaxHR** & **ChestPainType** (ChestPainType is heavily weighted, so maybe not so relevant for an interaction term)
  + **MaxHR** & **Age**
 
We will now perform some model selection approaches, to further examine which variables appear as significant.

**BSS**:
```{r}
library(leaps)
library(glmnet)
#We fit BSS on the whole data set, because we evaluate Cp, BIC and Adjusted R^2
bss.fit1<-regsubsets(HeartDisease~., data=heart_dat, nvmax=15)
sum.bss.fit<-summary(bss.fit1)
sum.bss.fit
```

The above summary shows the variable selection process of the Best Subset Selection method, but which model size is the most appropriate?

Let's observe Cp, BIC and AdjR2
```{r}
par(mfrow=c(1,3))
plot(sum.bss.fit$cp, xlab="Number of Variables", ylab="Cp", type="l")+
  abline(h=min(sum.bss.fit$cp)+.2*sd(sum.bss.fit$cp), col=2, lty=2)+
  abline(h=min(sum.bss.fit$cp)-.2*sd(sum.bss.fit$cp), col=2, lty=2)
plot(sum.bss.fit$bic, xlab="Number of Variables", ylab="BIC", type="l")+
  abline(h=min(sum.bss.fit$bic)+.2*sd(sum.bss.fit$bic), col=2, lty=2)+
  abline(h=min(sum.bss.fit$bic)-.2*sd(sum.bss.fit$bic), col=2, lty=2)
plot(sum.bss.fit$adjr2, xlab="Number of Variables", ylab="Adjr2", type="l", ylim=c(.4, .6))+
  abline(h=max(sum.bss.fit$adjr2)+.2*sd(sum.bss.fit$adjr2), col=2, lty=2)+
  abline(h=max(sum.bss.fit$adjr2)-.2*sd(sum.bss.fit$adjr2), col=2, lty=2)
```

We are not necessarily looking for the extrema, we want the smaller number of parameters within the bounds (0.2 standard deviations from the optimum).

From this, all measures agree on a model of size 7, perhaps even 6. If we do not care about the number of parameters, then perhaps size 10 would be best.

Let's see what size model 10-fold CV picks:

Need to create a predict function and then perform 10-fold CV:
```{r}
predict.regsubsets<-function(object, newdata, id,...){
  form<-as.formula(object$call[[2]])
  mat<-model.matrix(form, newdata)
  coefs<-coef(object, id=id)
  xvars<-names(coefs)
  mat[,xvars]%*%coefs
}
```

```{r}
#10-fold CV:
k<-10
set.seed(1)
folds<-sample(rep(1:k, length=nrow(heart_dat)))
cv.errors<-matrix(NA, k, 15, dimnames = list(NULL, paste(1:15)))

for(i in 1:k){
  bss.fit<-regsubsets(HeartDisease~., data=heart_dat[folds!=i,], nvmax=15)
  for(j in 1:15){
    preds<-predict.regsubsets(bss.fit, heart_dat[folds==i,], id=j)
    cv.errors[i,j]<-mean((heart_dat$HeartDisease[folds==i]-preds)^2)
  }
}
mean.cv.errors<-apply(cv.errors, 2, mean)
plot(mean.cv.errors, pch=19, type="b")+
  points(which.min(mean.cv.errors), mean.cv.errors[which.min(mean.cv.errors)],
         col=2, cex=2)
```

The lowest CV error is achieved by a model of size 11.

No we need to ask ourselves whether interpretability is important here. Because if it is not we should aim for the smallest error, without caring for the number of parameters.

Let's compare the CV erros of sizes 6, 7, 10 and 12.
```{r}
mean.cv.errors[12]
mean.cv.errors[10]
mean.cv.errors[7]
mean.cv.errors[6]
```

As said, the error gets worse the more we drop predictors, and 6 predictors is much simpler than 12, however for our goal which one is better? Accuracy or interpretability?

Let's check the 12 and 7 variable model picked by BSS:
```{r}
coef(bss.fit1,12)
coef(bss.fit1,7)
```

Gotta decide if I go with 12 or 7.
